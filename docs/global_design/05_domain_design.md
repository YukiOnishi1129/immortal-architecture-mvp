# ドメイン設計書

## エンティティ

| エンティティ | 説明 | 主な属性（プロパティ） |
|------------|------|---------------------|
| Account | ログインしているユーザー。ノートやテンプレートの作成者 | id, name, email, authId |
| Template | ノートのフォーマット。入力欄（Field）を定義する | id, name, ownerId, fields[], updatedAt |
| Field | テンプレート内の1つの入力欄 | id, label, order, isRequired |
| Note | 設計メモ1件。テンプレートを使って書かれる | id, title, templateId, ownerId, status, sections[], createdAt, updatedAt |
| Section | ノート内の1つの欄（Fieldに対応） | id, fieldId, content |
| Status | ノートの状態。下書き（Draft）か公開（Publish） | draft, publish |

## VO（Value Object）

| 名前 | 使う場所 | 守るルール（ほんの少しの約束） | 例 | 備考 |
|-----|---------|--------------------------|-----|------|
| Email | Account.email | 「@」が必ずある／空NG／前後の空白トリム | user@example.com | みんなで同じルール、間違うと困るのでVOにする |
| Status | Note.status | Draft または Publish だけOK | Draft / Publish | アプリの意味が強い（公開/下書き）のでVOにする |

## 集約

| **🏷️ チーム名（集約）** | **👑 集約ルート（リーダー）** | **👥 中にいるメンバー（子エンティティ・VO）** | **🔗 外との関係・使い方** | **💬 チームの役割（ざっくり）** |
|-------------------|------------------------|-----------------------------------|---------------------|---------------------------|
| 🟦 **Noteチーム** | **Note** | - Section（本文の各パート）<br>- Status（状態） | - Templateを参照（どの型で書くか）<br>- Accountに属する（Owner） | テンプレを使って1件のノートを作るチーム。Noteがリーダーで、Sectionは中身 |
| 🟩 **Templateチーム** | **Template** | - Field（入力欄の定義） | - Accountに属する（Owner）<br>- Noteから利用される | ノートの型（構造）を定義するチーム。Templateがリーダーで、Fieldがその中のパーツ |
| 🟨 **Accountチーム** | **Account** | （子なし）※ Email（VO）を保持 | - Note／Templateを所有する | ログインユーザーを表すチーム。他チームの親（所有者） |
| ⚪ **共通VO**（どのチームにも属さない小さな部品） | なし（単独） | - Email（Account用）<br>- Status（Note用） | 各チームで使われる共通ルール | |

### 🧩 関係図で見るとこんな感じ

```
[Account]──owns──>[Template]──contains──>[Field]
     │
     └──owns──>[Note]──contains──>[Section]
                       │
                       └──uses──>[Template]
```

## ドメインロジック

### 🟦 Noteチーム（ノートの世界）

| **🧩 ルール** | **💬 なにをしてる？** |
|-------------|-------------------|
| ノートを作るときはテンプレートが必要 | ノートが「テンプレートがないと書けない」と決めている |
| ノートを消したら中のセクションも一緒に消す | ノートが親分で、セクションはその子。親が消えたら子も一緒に消える |
| ステータスは「下書き」か「公開」だけ | ほかの言葉（例：プレビュー）は使えない。2つの状態しか持たない |
| ステータスを変えられるのはオーナーだけ（判定だけ） | 誰が変えられるかをノートの中で判断する。「自分のノートだけOK」 |
| 新しいノートを作るとき、テンプレートの項目からセクションを自動で作る | テンプレートの「書く欄」を読んで、ノートが自分の中に欄をコピーする |

### 🟩 Templateチーム（テンプレートの世界）

| **🧩 ルール** | **💬 なにをしてる？** |
|-------------|-------------------|
| Field（項目）の順番はかぶらない | テンプレートの中で、1番・2番・3番が重ならないように並べる |
| Field（項目）の名前は空じゃダメ | 「問題」「決定」など、欄の名前がないと使えないから |
| Fieldの追加・削除・並べ替えはテンプレートがまとめて行う | 子どものFieldを勝手に触れないように、親のテンプレートが管理する |

### 🟨 Accountチーム（アカウントの世界）

| **🧩 ルール** | **💬 なにをしてる？** |
|-------------|-------------------|
| 名前は空にできない | 名前がないと誰かわからないから、必ず書くようにしている |
| アカウントは自分のノートとテンプレートを"持つ" | 自分のものだけを見たり直したりできるように関係を持っている |

### ⚪ 共通ルール（どのチームでも同じ）

| **🧩 ルール** | **💬 なにをしてる？** |
|-------------|-------------------|
| 子ども（SectionやField）は、親（NoteやTemplate）を通してしか触れない | 外から直接いじれないように、親がまとめて面倒を見る |
| チームの中のモノは、チームごとに保存・変更する | 別のチームのデータを勝手に直さないようにしている |

## ドメインサービス

| **🧩 サービス名** | **💬 どんな仕事？** | **🏗️ 関わるドメイン（集約）** |
|----------------|-----------------|------------------------|
| NoteSectionBuilder | テンプレートの項目（Field）を見て、ノートのセクション（Section）を自動で作る。テンプレートの構造を使ってノートの中身を作るお手伝い係 | Template ＋ Note |
| StatusPolicy | ノートを「下書き→公開」にしていいかを判定する。オーナーならOK、他人ならNGという条件をチェックする係 | Note ＋ Account |